name: SMD Firmware Build & Release

on:
  # Build on every push to main and feature branches, and on version tags
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
    tags:
      - 'smd-v*'
    paths:
      - 'ESP32_AP-Flasher/**'
      - '.github/workflows/smd-release.yml'
      - '.github/actions/setup-pio/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: false

jobs:
  build:
    name: Build SMD Firmware
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PlatformIO
        uses: ./.github/actions/setup-pio

      - name: Get Version Info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/smd-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            IS_RELEASE="true"
          else
            # For non-tag builds, use branch name and short SHA
            BRANCH="${GITHUB_REF#refs/heads/}"
            BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9]/-/g')
            SHORT_SHA="${GITHUB_SHA:0:7}"
            VERSION="dev-${BRANCH_SAFE}-${SHORT_SHA}"
            IS_RELEASE="false"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (release: $IS_RELEASE)"

      - name: Build SMD 2.9" Generic Firmware
        env:
          PLATFORMIO_BUILD_FLAGS: >-
            -D BUILD_VERSION=\"${{ steps.version.outputs.version }}\"
            -D SHA=\"${{ github.sha }}\"
        run: |
          cd ESP32_AP-Flasher
          pio run --environment SMD_2inch9_generic

      - name: Build SMD 4.2" Generic Firmware
        env:
          PLATFORMIO_BUILD_FLAGS: >-
            -D BUILD_VERSION=\"${{ steps.version.outputs.version }}\"
            -D SHA=\"${{ github.sha }}\"
        run: |
          cd ESP32_AP-Flasher
          pio run --environment SMD_4inch2_generic

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts

          # Copy firmware binaries with descriptive names
          cp ESP32_AP-Flasher/.pio/build/SMD_2inch9_generic/firmware.bin artifacts/smd-2inch9-${{ steps.version.outputs.version }}.bin
          cp ESP32_AP-Flasher/.pio/build/SMD_4inch2_generic/firmware.bin artifacts/smd-4inch2-${{ steps.version.outputs.version }}.bin

          # Generate checksums
          cd artifacts
          sha256sum *.bin > checksums.sha256
          cat checksums.sha256

          # Create build metadata JSON
          cat > build-info.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "is_release": ${{ steps.version.outputs.is_release }},
            "firmware": [
              {
                "type": "SMD_2inch9",
                "display": "2.9 inch (296x128)",
                "file": "smd-2inch9-${{ steps.version.outputs.version }}.bin"
              },
              {
                "type": "SMD_4inch2",
                "display": "4.2 inch (400x300)",
                "file": "smd-4inch2-${{ steps.version.outputs.version }}.bin"
              }
            ],
            "provisioning": {
              "method": "serial",
              "protocol": "json",
              "commands": ["get_info", "set_wifi", "set_wifi_backup", "set_server", "provision", "reset", "reboot"]
            }
          }
          EOF
          cat build-info.json

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smd-firmware-${{ steps.version.outputs.version }}
          path: artifacts/
          retention-days: 30

      # Only create releases for tagged builds or manual dispatch with create_release=true
      - name: Create GitHub Release
        if: steps.version.outputs.is_release == 'true' || (github.event_name == 'workflow_dispatch' && inputs.create_release)
        uses: softprops/action-gh-release@v2
        with:
          name: SMD Firmware ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          generate_release_notes: true
          body: |
            ## Smart Manufacturing Display Firmware

            Pre-built firmware for SMD devices with serial-based provisioning.

            ### Available Firmware

            | Display | File | Resolution |
            |---------|------|------------|
            | 2.9" ePaper | `smd-2inch9-${{ steps.version.outputs.version }}.bin` | 296x128 |
            | 4.2" ePaper | `smd-4inch2-${{ steps.version.outputs.version }}.bin` | 400x300 |

            ### Installation

            1. Download the firmware for your display size
            2. Flash using ESL Manager's web installer or esptool
            3. Configure WiFi and server URL via serial provisioning

            ### Serial Provisioning Commands

            After flashing, connect via USB serial (115200 baud) and send JSON commands:

            ```json
            {"cmd": "get_info"}
            {"cmd": "set_wifi", "ssid": "YourNetwork", "password": "YourPassword"}
            {"cmd": "set_server", "url": "http://your-server:3001"}
            {"cmd": "provision"}
            ```

            ### Checksums

            See `checksums.sha256` for file integrity verification.

          files: |
            artifacts/smd-2inch9-${{ steps.version.outputs.version }}.bin
            artifacts/smd-4inch2-${{ steps.version.outputs.version }}.bin
            artifacts/checksums.sha256
            artifacts/build-info.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
